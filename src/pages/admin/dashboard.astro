---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { supabase } from '../../lib/supabaseClient';
import { Inbox, User, Calendar, Mail } from 'lucide-react';

// SERVER SIDE LOGIC (Runs on build/request)
// Fetch messages from Supabase
const { data: messages, error } = await supabase
  .from('messages')
  .select('*')
  .order('created_at', { ascending: false });

---


// 1. Check if user is logged in
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/signin');
}

// 2. Check if user is Admin (Replace with Abel's actual email used for signup)
const ADMIN_EMAIL = 'bereketdesigns@gmail.com'; // CHANGE THIS TO YOUR LOGIN EMAIL

if (session.user.email !== ADMIN_EMAIL) {
  return Astro.redirect('/dashboard'); // Kick normal users back to student dashboard
}

<DashboardLayout>
  
  <div class="mb-8 flex items-end justify-between">
    <div>
      <h1 class="text-3xl font-heading text-white">Command Center</h1>
      <p class="text-slate-400 mt-2">Incoming transmissions and applications.</p>
    </div>
    <div class="px-4 py-2 bg-pelican-coral/10 border border-pelican-coral/20 rounded-lg text-pelican-coral text-sm font-bold">
      {messages?.length || 0} Total Messages
    </div>
  </div>

  <!-- Messages List -->
  <div class="space-y-4">
    
    {(!messages || messages.length === 0) && (
      <div class="text-center py-20 bg-white/5 rounded-2xl border border-white/10">
        <Inbox size={48} className="mx-auto text-slate-600 mb-4" />
        <p class="text-slate-400">No messages received yet.</p>
      </div>
    )}

    {messages?.map((msg) => (
      <div class="bg-white/5 border border-white/10 rounded-xl p-6 hover:border-pelican-coral/50 transition-colors group">
        <div class="flex flex-col md:flex-row md:items-start justify-between gap-4">
          
          {/* Header Info */}
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center text-blue-400 shrink-0">
              <User size={20} />
            </div>
            <div>
              <h3 class="text-white font-bold text-lg">{msg.name}</h3>
              <div class="flex items-center gap-4 text-xs text-slate-400 mt-1">
                 <span class="flex items-center"><Mail size={12} class="mr-1"/> {msg.email}</span>
                 <span class="flex items-center"><Calendar size={12} class="mr-1"/> {new Date(msg.created_at).toLocaleDateString()}</span>
                 <span class="bg-white/10 px-2 py-0.5 rounded text-white">{msg.inquiry_type}</span>
                 {msg.age && <span class="bg-white/10 px-2 py-0.5 rounded text-white">Age: {msg.age}</span>}
              </div>
            </div>
          </div>

          {/* Action (Optional - Mailto) */}
          <a href={`mailto:${msg.email}`} class="px-4 py-2 bg-white/10 hover:bg-white hover:text-black text-white text-sm font-bold rounded-lg transition-colors whitespace-nowrap">
            Reply via Email
          </a>

        </div>

        {/* Message Body */}
        <div class="mt-6 pl-16 border-l-2 border-white/10">
          <p class="text-slate-300 leading-relaxed text-sm">
            {msg.message}
          </p>
        </div>
      </div>
    ))}

  </div>

</DashboardLayout>