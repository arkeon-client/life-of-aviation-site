---
// src/pages/blog/[slug].astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import AuroraBackground from '../../components/ui/AuroraBackground.astro';
import Newsletter from '../../components/Newsletter.astro';
import { ArrowLeft, Calendar, User } from 'lucide-react';
import { supabase } from '../../lib/supabaseClient';

const { slug } = Astro.params;

// 1. FETCH POST FROM DB (Server Side)
const { data: post } = await supabase
  .from('blog_posts')
  .select('*')
  .eq('slug', slug)
  .single();

// 2. Handle 404
if (!post) {
  return Astro.redirect('/404');
}
---

<BaseLayout title={post.title} description={post.description}>
  <article class="relative min-h-screen pt-32 pb-24 overflow-hidden">
    <AuroraBackground />
    
    <div class="max-w-4xl mx-auto px-4 relative z-10">
      
      <a href="/blog" class="inline-flex items-center text-slate-400 hover:text-pelican-coral transition-colors mb-8 group">
        <ArrowLeft className="w-4 h-4 mr-2 group-hover:-translate-x-1 transition-transform" />
        Back to Flight Log
      </a>

      <div class="mb-12 text-center">
        <div class="flex items-center justify-center gap-4 text-sm text-pelican-coral font-bold tracking-widest uppercase mb-6">
          <span class="flex items-center"><Calendar class="w-4 h-4 mr-2"/> {new Date(post.created_at).toLocaleDateString()}</span>
          <span class="w-1 h-1 rounded-full bg-slate-600"></span>
          <span class="flex items-center"><User class="w-4 h-4 mr-2"/> {post.author}</span>
        </div>
        
        <h1 class="font-heading text-4xl md:text-6xl text-white font-bold leading-tight mb-8">
          {post.title}
        </h1>

        {post.image_url && (
          <div class="rounded-3xl overflow-hidden border border-white/10 shadow-2xl relative aspect-video">
            <img src={post.image_url} alt={post.title} class="w-full h-full object-cover" />
            <div class="absolute inset-0 bg-gradient-to-t from-[#020617] via-transparent to-transparent opacity-60"></div>
          </div>
        )}
      </div>

      {/* RENDER HTML CONTENT (Quill output) */}
      <div class="rich-text prose prose-lg prose-invert max-w-none prose-headings:font-heading prose-headings:text-white prose-p:text-slate-300 prose-a:text-pelican-coral prose-strong:text-white">
        <div set:html={post.content} />
      </div>

      <div class="w-full h-px bg-white/10 my-16"></div>

      <Newsletter />

    </div>
  </article>
</BaseLayout>