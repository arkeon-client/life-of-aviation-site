---
import BaseLayout from '../../layouts/BaseLayout.astro';
import AuroraBackground from '../../components/ui/AuroraBackground.astro';
import SpotlightCard from '../../components/ui/SpotlightCard';
import Newsletter from '../../components/Newsletter.astro';
import { Calendar, ArrowRight } from 'lucide-react';
import { supabase } from '../../lib/supabaseClient'; // Use Supabase

// FETCH POSTS FROM DB
const { data: posts } = await supabase
  .from('blog_posts')
  .select('*')
  .order('created_at', { ascending: false });

const allPosts = posts || [];
---

<BaseLayout title="Aviation Stories">
  <section class="relative min-h-screen pt-32 pb-20 overflow-hidden">
    <AuroraBackground />

    <div class="max-w-6xl mx-auto px-4 relative z-10">
      
      <div class="text-center mb-16">
        <h1 class="font-heading text-5xl md:text-6xl font-bold text-white mb-6">Flight Log</h1>
        <p class="text-slate-300 text-xl">Insights from the cockpit.</p>
      </div>

      <div class="flex flex-col gap-8 mb-20">
        {allPosts.map((post) => (
          <a href={`/blog/${post.slug}`} class="block group">
            <SpotlightCard client:load className="bg-white/5 border border-white/10 p-0 overflow-hidden transition-all duration-500 hover:border-pelican-coral/50">
              <div class="flex flex-col md:flex-row h-full min-h-[280px]">
                
                {post.image_url && (
                  <div class="md:w-2/5 h-64 md:h-auto relative overflow-hidden border-b md:border-b-0 md:border-r border-white/5">
                     <img 
                      src={post.image_url} 
                      alt={post.title} 
                      class="w-full h-full object-cover opacity-90 group-hover:opacity-100 group-hover:scale-105 transition-all duration-700" 
                     />
                     <div class="absolute inset-0 bg-gradient-to-t from-[#020617]/80 via-transparent to-transparent md:bg-gradient-to-r"></div>
                  </div>
                )}
                
                <div class="p-8 md:p-10 md:w-3/5 flex flex-col justify-center relative">
                  <div class="flex items-center text-xs font-bold tracking-widest text-pelican-coral uppercase mb-4">
                    <Calendar class="w-3 h-3 mr-2" />
                    {new Date(post.created_at).toLocaleDateString()}
                  </div>
                  <h2 class="font-heading text-2xl md:text-3xl text-white mb-4 group-hover:text-pelican-coral transition-colors leading-tight">
                    {post.title}
                  </h2>
                  <p class="text-slate-400 mb-6 line-clamp-2 leading-relaxed">
                    {post.description}
                  </p>
                  <div class="mt-auto flex items-center text-white text-sm font-bold tracking-wide">
                    Read Article 
                    <span class="ml-2 w-8 h-8 rounded-full bg-white/10 flex items-center justify-center group-hover:bg-pelican-coral group-hover:text-white transition-all">
                      <ArrowRight class="w-4 h-4" />
                    </span>
                  </div>
                </div>

              </div>
            </SpotlightCard>
          </a>
        ))}
      </div>

      <Newsletter />
    </div>
  </section>
</BaseLayout>